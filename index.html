<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Descargar Stock - Crear Pedido</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* [styles included above, unchanged] */
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo Salpa" class="logo">
  </header>

  <div class="container">
    <h2>📦 Descargar Stock Disponible</h2>
    <div class="description">
      Descarga el inventario actual de tu ubicación de stock para crear un nuevo pedido de manera fácil y rápida.
    </div>
    <div class="features">
      <h3>🚀 Nuevo formato mejorado:</h3>
      <ul>
        <li>Hoja "PEDIDO" user-friendly para completar cantidades</li>
        <li>Nombres de productos limpios (sin códigos entre corchetes)</li>
        <li>Precios con descuento automático del 60%</li>
        <li>Cálculo automático de subtotales</li>
        <li>Filtrado automático de productos solicitados</li>
      </ul>
    </div>
    <div class="download-zone">
      <div class="download-icon">📈</div>
      <div class="download-text">Stock de Ubicación 8</div>
      <div class="download-hint">Descuento 60%<br>Se generará un archivo Excel optimizado</div>
    </div>
    <button class="download-btn" id="downloadBtn"><span id="downloadBtnText">📅 Descargar Stock Actual</span></button>
    <div class="status" id="status"></div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="next-step" id="nextStep" style="display: none;">
      <div class="next-step-title">🚀 Siguiente paso:</div>
      <p>
        1. Abre el archivo Excel descargado<br>
        2. Ve a la hoja "PEDIDO" y completa las cantidades<br>
        3. Los subtotales se calcularán automáticamente<br>
        4. Guarda el archivo<br>
        5. <a href="#" class="upload-link">Sube tu pedido aquí</a>
      </p>
    </div>
  </div>

  <script>
    const API_URL = 'https://pedido2-five.vercel.app/api/download-stock';
    const TEMPLATE_PATH = '/templates/pedido_template.xlsx';
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadBtnText = document.getElementById('downloadBtnText');
    const status = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const nextStep = document.getElementById('nextStep');

    function showStatus(type, message) {
      status.className = `status ${type}`;
      status.innerHTML = message;
      status.style.display = 'block';
    }

    function setProgress(percent) {
      progressFill.style.width = `${percent}%`;
      progressBar.style.display = 'block';
    }

    function cleanProductName(displayName) {
      return displayName.replace(/^\[.*?\]\s*/, '').trim();
    }

    async function loadTemplate() {
      const res = await fetch(TEMPLATE_PATH);
      const buf = await res.arrayBuffer();
      return XLSX.read(buf, { type: 'array', cellStyles: true });
    }

    function populatePedidoSheet(wb, products) {
      const ws = wb.Sheets['PEDIDO'];
      if (!ws) throw new Error('La plantilla no contiene una hoja "PEDIDO".');
      const headers = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, raw: false })[0];
      const rows = products.map((p, i) => [
        p.product_id,
        1,
        cleanProductName(p.display_name || p.name),
        p.qty_available,
        p.price,
        p.price * 0.4,
        '',
        { f: `IF(G${i + 2}<>"",F${i + 2}*G${i + 2},"")` }
      ]);
      const newRange = { s: { c: 0, r: 0 }, e: { c: headers.length - 1, r: rows.length } };
      ws['!ref'] = XLSX.utils.encode_range(newRange);
      XLSX.utils.sheet_add_aoa(ws, [headers], { origin: 'A1' });
      XLSX.utils.sheet_add_aoa(ws, rows, { origin: { r: 1, c: 0 } });
      ws['!autofilter'] = { ref: XLSX.utils.encode_range(newRange) };
    }

    async function downloadStock() {
      try {
        downloadBtn.disabled = true;
        downloadBtnText.innerHTML = '<div class="spinner"></div>Conectando...';
        showStatus('processing', '🔄 Cargando plantilla...');
        setProgress(10);

        const wb = await loadTemplate();
        wb.Workbook = wb.Workbook || {};
        wb.Workbook.CalcPr = { fullCalcOnLoad: true };

        showStatus('processing', '🔄 Conectando a Odoo...');
        setProgress(30);

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location_id: 8, pricelist_id: 5 })
        });

        setProgress(45);
        showStatus('processing', '📊 Procesando datos...');
        const data = await response.json();
        if (!data || !Array.isArray(data.products) || data.products.length === 0) {
          console.error('Respuesta completa de la API:', data);
          throw new Error(data?.error || 'No se encontraron productos.');
        }

        setProgress(70);
        showStatus('processing', '📄 Poblando hoja PEDIDO...');
        populatePedidoSheet(wb, data.products);

        setProgress(90);
        showStatus('processing', '📂 Generando archivo...');
        const filename = `pedido_stock_ubicacion_8_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, filename);

        setProgress(100);
        showStatus('success', `✅ ¡Descargado exitosamente!<br><strong>${filename}</strong><br>Productos disponibles: ${data.products.length}`);
        nextStep.style.display = 'block';
      } catch (err) {
        console.error('Error:', err);
        showStatus('error', `❌ Error: ${err.message}`);
        setProgress(0);
      } finally {
        setTimeout(() => {
          downloadBtn.disabled = false;
          downloadBtnText.innerHTML = '📅 Descargar Stock Actual';
        }, 3000);
      }
    }

    downloadBtn.addEventListener('click', downloadStock);
  </script>
</body>
</html>
