<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Descargar Stock desde Odoo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem;
    }
    select, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üì¶ Descargar Stock</h1>

  <label for="location_id">Ubicaci√≥n (Location ID):</label>
  <select id="location_id">
    <option value="8">8 - Stock Disponible Principal</option>
    <option value="14">14 - Local</option>
    <option value="15">15 - Dep√≥sito Interno</option>
  </select>

  <label for="pricelist_id">Lista de Precios:</label>
  <select id="pricelist_id">
    <option value="5">5 - P√∫blico General</option>
    <option value="8">8 - Mayorista</option>
  </select>

  <button id="downloadBtn">üì• Descargar Excel</button>
  <div id="status"></div>

  <script>
    async function fetchData(location_id, pricelist_id) {
      const response = await fetch("https://stockexcel.vercel.app/api/download-stock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ location_id, pricelist_id })
      });

      if (!response.ok) throw new Error(`Error: ${response.status}`);
      const data = await response.json();
      if (!data.success) throw new Error(data.error || "Fallo la API");
      return data.products;
    }

    function generateExcelData(products) {
      // Hoja oculta
      const auxHeaders = ['Cliente ID', 'Producto ID', 'C√≥digo', 'Producto', 'Stock Disponible', 'Precio', 'Cantidad', 'Subtotal'];
      const auxRows = products.map(p => [1, p.product_id, p.default_code, p.name, p.qty_available, p.price, '', '']);
      const auxSheet = XLSX.utils.aoa_to_sheet([auxHeaders, ...auxRows]);
      auxSheet['!cols'] = Array(auxHeaders.length).fill({ width: 15 });

      // Hoja visible PEDIDO
      const pedidoHeaders = ['C√≥digo', 'Producto', 'Stock', 'Precio', 'Cantidad', 'Subtotal'];
      const pedidoRows = products.map((p, i) => {
        const cantidadCell = `E${i + 2}`;
        const precioCell = `D${i + 2}`;
        return [
          p.default_code,
          p.name,
          p.qty_available,
          p.price,
          '',
          { f: `${cantidadCell}*${precioCell}` }
        ];
      });
      const pedidoSheet = XLSX.utils.aoa_to_sheet([pedidoHeaders, ...pedidoRows]);
      pedidoSheet['!cols'] = [
        { width: 15 }, { width: 30 }, { width: 12 },
        { width: 12 }, { width: 12 }, { width: 15 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, auxSheet, 'AUX_IMPORT');
      XLSX.utils.book_append_sheet(wb, pedidoSheet, 'PEDIDO');

      // Ocultar AUX_IMPORT
      wb.Workbook = {
        Sheets: [{ name: 'AUX_IMPORT', Hidden: 1 }]
      };

      return wb;
    }

    function downloadExcel(workbook, filename) {
      XLSX.writeFile(workbook, filename);
    }

    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const location_id = document.getElementById("location_id").value;
      const pricelist_id = document.getElementById("pricelist_id").value;
      const status = document.getElementById("status");

      try {
        status.textContent = "‚è≥ Descargando datos...";
        const products = await fetchData(location_id, pricelist_id);
        if (products.length === 0) {
          status.textContent = "‚ö†Ô∏è No hay productos disponibles para esta ubicaci√≥n.";
          return;
        }
        const workbook = generateExcelData(products);
        const timestamp = new Date().toISOString().slice(0, 16).replace(/[-:T]/g, "");
        downloadExcel(workbook, `stock_${timestamp}.xlsx`);
        status.textContent = `‚úÖ ${products.length} productos exportados.`;
      } catch (err) {
        status.textContent = `‚ùå Error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
